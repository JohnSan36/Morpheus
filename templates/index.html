<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Morpheus</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <h3 class="sidebar-header">Modelos</h3>
            <div class="chat-modes">
                <div class="mode-dropdown">
                    <button class="mode-button active" data-provider="ollama">Ollama ▼</button>
                    <div class="dropdown-content">
                        <a href="#" data-mode="ollama-qwen3:8b">qwen3:8b</a>
                        <a href="#" data-mode="ollama-dolphin-llama3:8b">dolphin-llama3:8b</a>
                        <a href="#" data-mode="ollama-dolphin-mistral:latest">dolphin-mistral:latest</a>
                    </div>
                </div>
                <div class="mode-dropdown">
                    <button class="mode-button" data-provider="google">Google ▼</button>
                    <div class="dropdown-content">
                        <a href="#" data-mode="gemini-flash">Gemini Flash 2.5</a>
                        <a href="#" data-mode="gemini-pro">Gemini Pro 2.5</a>
                    </div>
                </div>
                <div class="mode-dropdown">
                    <button class="mode-button" data-provider="openai">OpenAI ▼</button>
                    <div class="dropdown-content">
                        <a href="#" data-mode="gpt4o">GPT-4o</a>
                        <a href="#" data-mode="gpt4o-mini">GPT-4o Mini</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="chat-container">
            <header class="chat-header">
                <button class="menu-button" id="menu-button">
                    <i class="fas fa-bars"></i>
                </button>
                <h2>Morpheus</h2>
            </header>
            <div class="chat-messages" id="chat-messages">
            </div>
            <form class="chat-input-form" id="chat-form">
                <textarea id="mensagem" placeholder="Digite sua mensagem..." rows="1" required></textarea>
                <button type="submit" title="Enviar Mensagem">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>                                      

    <script>
        const chatMessages = document.getElementById("chat-messages");
        const chatForm = document.getElementById("chat-form");
        const mensagemInput = document.getElementById("mensagem");
        let currentMode = "ollama-qwen3:8b"; // Default model

        function updateActiveButton(activeProviderButton) {
            document.querySelectorAll('.mode-dropdown .mode-button').forEach(btn => btn.classList.remove('active'));
            if (activeProviderButton) {
                activeProviderButton.classList.add('active');
            }
        }

        // Initialize with Ollama active
        updateActiveButton(document.querySelector('[data-provider="ollama"]'));

        // Handle model selection from any dropdown
        document.querySelectorAll('.dropdown-content a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Get selected mode and update the global variable
                currentMode = e.currentTarget.dataset.mode;
                
                // Find the parent provider button
                const parentDropdown = e.currentTarget.closest('.mode-dropdown');
                const providerButton = parentDropdown.querySelector('.mode-button');
                
                // Update UI
                updateActiveButton(providerButton);
                providerButton.textContent = `${providerButton.dataset.provider.charAt(0).toUpperCase() + providerButton.dataset.provider.slice(1)} (${e.currentTarget.textContent}) ▼`;
                
                addMessage("assistant", `Modelo alterado para: ${e.currentTarget.textContent}`);
            });
        });

        // Função para adicionar uma mensagem ao chat
        function addMessage(sender, text) {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("chat-message", sender);
            messageDiv.innerHTML = `<div class="message-bubble">${text.replace(/\n/g, '<br>')}</div>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Adiciona uma mensagem inicial do assistente
        addMessage("assistant", "Olá! Como posso ajudar você hoje?");

        // Função para enviar a mensagem
        async function sendMessage() {
            const mensagem = mensagemInput.value.trim();
            if (!mensagem) return;

            addMessage("user", mensagem);
            mensagemInput.value = "";
            mensagemInput.style.height = 'auto';

            console.log("Enviando mensagem:", mensagem, "Modo:", currentMode);

            try {
                const response = await fetch("http://localhost:8001/web", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ mensagem: mensagem, mode: currentMode })
                });

                console.log("Response status:", response.status);
                console.log("Response ok:", response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log("Result:", result);
                
                const assistantResponse = result.text || "Desculpe, não consegui obter uma resposta.";
                addMessage("assistant", assistantResponse);
            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
                addMessage("assistant", `Erro: ${error.message}`);
            }
        }

        // Evento de submit do formulário (para o botão de envio)
        chatForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            sendMessage();
        });

        // Evento para lidar com as teclas Enter e Shift + Enter no textarea
        mensagemInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                if (!event.shiftKey && !event.ctrlKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }
        });

        // Ajusta a altura do textarea dinamicamente
        mensagemInput.addEventListener('input', () => {
            mensagemInput.style.height = 'auto';
            mensagemInput.style.height = (mensagemInput.scrollHeight) + 'px';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // Opcional: Garante que o textarea esteja focado ao carregar a página
        window.addEventListener('load', () => {
            mensagemInput.focus();
        });

        // Esconder seletor quando clicar fora
        document.addEventListener("click", (e) => {
            const dropdownButton = document.getElementById("mode-ollama");
            const dropdownContent = document.querySelector('.dropdown-content');
            if (!dropdownButton.contains(e.target) && !dropdownContent.contains(e.target)) {
                dropdownContent.style.display = "none";
            }
        });

        // Hamburger Menu Logic
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        const mainContainer = document.querySelector('.main-container');

        menuButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevents the document click listener from firing
            sidebar.classList.toggle('open');
        });

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
            if (sidebar.classList.contains('open') && !sidebar.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });
    </script>
</body>
</html>